<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹è¡¨ V7.12 (å®‰å®šç‰ˆï¼šå…¨ä¸å…·åˆä¿®æ­£)</title>
    <style>
        :root {
            --zoom: 1.0;
            --day-width: calc(30px * var(--zoom));
            --header-h: calc(100px * var(--zoom));
            --row-h: calc(52px * var(--zoom));
            --font-size: calc(13px * var(--zoom));
            --border-color: #cbd5e1;
            --header-bg: #f8fafc;
            --primary-color: #2563eb;
            --prop-bg: #0f172a;
            --prop-color: #ffffff;
            --cat-bg: #e2e8f0;
            --cat-color: #1e293b;
            --list-viewport-w: 650px;

            /* Individual Base Widths (Internal Column Resizing) */
            --col-btn-base: 50px;
            --col-gouki-base: 90px;
            --col-prop-base: 140px;
            --col-name-base: 240px;
            --col-date-base: 150px;
            --col-h-base: 75px;
            --col-note-base: 180px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Meiryo", system-ui, sans-serif;
            margin: 0;
            padding: 10px;
            color: #1e293b;
            background: #f1f5f9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: var(--font-size);
        }

        #main-app {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            min-height: 0;
            /* Important for internal scrolling */
        }

        .header-banner {
            background: #0f172a;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            border-radius: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-banner h1 {
            font-size: 1.3rem;
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        /* --- SCREENS --- */
        #login-screen,
        #master-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #master-screen {
            background: #f1f5f9;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            /* Prevent body scroll */
        }

        #login-form {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 350px;
            text-align: center;
        }

        #login-form h2 {
            margin-bottom: 20px;
            color: #0f172a;
        }

        .m-container {
            width: 1000px;
            max-width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .m-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 30px 30px 30px;
        }

        .m-tabs {
            display: flex;
            gap: 20px;
            padding: 0 30px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
            background: #fff;
        }

        .m-tab-btn {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            color: #64748b;
            transition: all 0.2s;
        }

        .m-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .m-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #fff;
            z-index: 100;
        }

        .m-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .m-table th,
        .m-table td {
            border: 1px solid #cbd5e1;
            padding: 12px;
            text-align: left;
        }

        .m-table th {
            background: #f8fafc;
        }

        .permission-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-admin {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-user {
            background: #dcfce7;
            color: #166534;
        }

        .badge-viewer {
            background: #f1f5f9;
            color: #475569;
        }

        .hidden-view {
            display: none !important;
        }

        [disabled] {
            opacity: 0.6;
            cursor: not-allowed !important;
        }

        input,
        select {
            padding: 5px 8px;
            border: 1.5px solid #cbd5e1;
            border-radius: 6px;
            font-size: inherit;
        }

        button {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: inherit;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        button.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .gantt-wrapper {
            flex: 1;
            display: flex;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-height: 0;
            /* Important for internal scrolling */
        }

        /* --- LEFT PANEL --- */
        .gantt-list {
            width: var(--list-viewport-w);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border-right: 3px solid #475569;
            z-index: 20;
            background: white;
            min-height: 0;
            /* Important for internal scrolling */
        }

        .list-header-outer {
            height: var(--header-h);
            background: var(--header-bg);
            border-bottom: 2px solid var(--border-color);
            overflow: hidden;
        }

        .list-header-content {
            display: flex;
            width: fit-content;
            height: 100%;
        }

        .list-body {
            flex: 1;
            overflow: auto;
            width: 100%;
            border-right: 1px solid #f1f5f9;
            background: white;
            cursor: auto;
        }

        /* --- RIGHT PANEL --- */
        .gantt-timeline-panel {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .timeline-header {
            height: var(--header-h);
            background: var(--header-bg);
            position: sticky;
            top: 0;
            z-index: 50;
            /* Higher than bars (10) and milestones (12) */
            border-bottom: 2px solid var(--border-color);
        }

        .header-row {
            display: flex;
            height: calc(100% / 3);
            border-bottom: 1px solid #e2e8f0;
        }

        .cell {
            position: relative;
            /* Fixed: For resizers and absolute elements */
            padding: 2px 8px;
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            flex: 0 0 auto;
            min-width: 0;
            overflow: hidden;
            height: 100%;
        }

        .cell.header {
            justify-content: center;
            font-weight: bold;
            font-size: 0.95em;
            color: #475569;
            background: var(--header-bg);
            white-space: nowrap;
        }

        /* Timeline Header Cells */
        .header-cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            font-size: 0.9em;
            color: #475569;
            background: var(--header-bg);
        }

        .header-cell.day {
            width: var(--day-width);
            flex-direction: column;
            font-size: 0.8em;
            flex-shrink: 0;
        }

        /* Column Resizers inside Column Headers */
        .col-resizer {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            z-index: 20;
        }

        .col-resizer:hover {
            background: var(--primary-color);
        }

        /* ROWS */
        .row-container {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            min-height: var(--row-h);
            align-items: stretch;
            width: fit-content;
            position: relative;
            /* Fixed: Absolute bars need a relative parent */
        }

        .row-container.prop-row {
            background: var(--prop-bg);
            color: var(--prop-color);
            font-weight: bold;
        }

        .row-container.cat-row {
            background: var(--cat-bg);
            color: var(--cat-color);
            font-weight: 600;
        }

        .cell input,
        .cell button {
            max-width: 100%;
            margin: 0;
        }

        .cell input {
            width: 100%;
            height: 80%;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: inherit;
            padding: 0 4px;
        }

        /* Column Width Definitions (linked to base * zoom) */
        .col-btn {
            width: calc(var(--col-btn-base) * var(--zoom));
            flex: 0 0 calc(var(--col-btn-base) * var(--zoom));
            justify-content: center;
        }

        .col-gouki {
            width: calc(var(--col-gouki-base) * var(--zoom));
            flex: 0 0 calc(var(--col-gouki-base) * var(--zoom));
        }

        .col-prop {
            width: calc(var(--col-prop-base) * var(--zoom));
            flex: 0 0 calc(var(--col-prop-base) * var(--zoom));
        }

        .col-name {
            width: calc(var(--col-name-base) * var(--zoom));
            flex: 0 0 calc(var(--col-name-base) * var(--zoom));
        }

        .col-date {
            width: calc(var(--col-date-base) * var(--zoom));
            flex: 0 0 calc(var(--col-date-base) * var(--zoom));
        }

        .col-h {
            width: calc(var(--col-h-base) * var(--zoom));
            flex: 0 0 calc(var(--col-h-base) * var(--zoom));
        }

        .col-note {
            width: calc(var(--col-note-base) * var(--zoom));
            flex: 0 0 calc(var(--col-note-base) * var(--zoom));
        }

        .main-resizer {
            width: 6px;
            cursor: col-resize;
            background: #cbd5e1;
            z-index: 20;
        }

        .main-resizer:hover {
            background: var(--primary-color);
        }

        /* Timeline and Bars */
        .timeline-body {
            position: relative;
            width: fit-content;
        }

        .grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .task-bar {
            position: absolute;
            top: 25%;
            height: 50%;
            z-index: 10;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
            color: white;
            font-size: 0.85em;
            font-weight: 700;
            display: flex;
            align-items: center;
            padding: 0 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
            white-space: nowrap;
            overflow: hidden;
        }

        .task-bar.summary {
            background: linear-gradient(135deg, #94a3b8, #475569);
            opacity: 0.8;
            height: 35%;
            top: 32.5%;
        }

        .task-bar.prop {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            height: 30%;
            top: 35%;
        }

        .bar-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: ew-resize;
        }

        .bar-handle.left {
            left: 0;
        }

        .bar-handle.right {
            right: 0;
        }

        .holiday {
            background-color: #fee2e2;
        }

        .saturday {
            background-color: #e0f2fe;
        }

        .today-hl {
            background-color: #fef3c7;
            color: #d97706;
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2.5px;
            background: #f59e0b;
            z-index: 15;
            pointer-events: none;
        }

        .folder-toggle {
            cursor: pointer;
            width: 20px;
            display: inline-flex;
            justify-content: center;
        }

        .folder-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .hidden {
            display: none !important;
        }

        /* Milestone (Diamond) styles */
        .task-bar.milestone {
            background: none;
            box-shadow: none;
            overflow: visible;
            width: 0 !important;
            padding: 0;
            z-index: 12;
        }

        .task-bar.milestone::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            transform: translate(-50%, -50%) rotate(45deg);
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .milestone-label {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            white-space: nowrap;
            color: #1e293b;
            font-size: 0.85em;
            font-weight: bold;
            pointer-events: none;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-body {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
        }

        .checklist-item:hover {
            background: #f8fafc;
        }
    </style>
</head>

<body>

    <div id="login-screen"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.9); z-index:9999; align-items:center; justify-content:center;">
        <div id="login-form">
            <h2>Gantt Login</h2>
            <div style="margin-bottom: 20px;">
                <input type="text" id="login-id" placeholder="ç¤¾å“¡ç•ªå· ã¾ãŸã¯ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autofocus
                    style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:6px; margin-bottom:10px;"
                    onkeydown="if(event.key==='Enter') document.getElementById('login-pass').focus()">
                <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å¿…é ˆ)"
                    style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:6px; margin-bottom:10px;"
                    onkeydown="if(event.key==='Enter') doLogin()">
                <p id="login-error" style="color:#ef4444; font-size:0.85em; display:none;">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</p>
            </div>
            <button class="primary" style="width:100%; padding:12px;" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p style="margin-top:20px; font-size:0.8em; color:#64748b;">ç®¡ç†è€…ID: admin / PW: fts2531de</p>
        </div>
    </div>

    <div id="master-screen">
        <div class="m-container">
            <div class="m-header">
                <h2>âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="importMasterCSV()"
                        style="background:#10b981; color:white; border:none;">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="m-csv-file" style="display:none;" onchange="handleMasterCSV(this)">
                    <button onclick="switchView('gantt')">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã«æˆ»ã‚‹</button>
                </div>
            </div>

            <div class="m-tabs">
                <div id="tab-users" class="m-tab-btn active" onclick="switchMasterTab('users')">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                <div id="tab-props" class="m-tab-btn" onclick="switchMasterTab('props')">ğŸ¢ ç‰©ä»¶ãƒ»åŒºåˆ†ãƒã‚¹ã‚¿</div>
                <div id="tab-l3" class="m-tab-btn" onclick="switchMasterTab('l3')">ğŸ“‹ å·¥ç¨‹åŒºåˆ†ãƒªã‚¹ãƒˆ</div>
                <div id="tab-cloud" class="m-tab-btn" onclick="switchMasterTab('cloud')">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰</div>
            </div>

            <div class="m-content">
                <div id="sec-users">
                    <table class="m-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åå‰</th>
                                <th style="width:150px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th>
                                <th>æ¨©é™</th>
                                <th style="width:80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="m-user-list"></tbody>
                    </table>
                    <div
                        style="display:flex; gap:10px; margin-bottom:30px; flex-wrap:wrap; background:#f8fafc; padding:15px; border-radius:8px;">
                        <input type="text" id="m-u-id" placeholder="ID" style="width:120px;">
                        <input type="text" id="m-u-name" placeholder="æ°å" style="width:120px;">
                        <input type="text" id="m-u-pass" placeholder="PW" style="width:100px;">
                        <select id="m-u-role">
                            <option value="user">ä¸€èˆ¬</option>
                            <option value="viewer">é–²è¦§</option>
                            <option value="admin">ç®¡ç†è€…</option>
                        </select>
                        <button class="primary" onclick="addMUser()">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                    </div>
                </div>

                <div id="sec-props" class="hidden-view">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4>ğŸ¢ ç‰©ä»¶ãƒã‚¹ã‚¿</h4>
                            <table class="m-table">
                                <thead>
                                    <tr>
                                        <th>ç‰©ä»¶å</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="m-prop-list"></tbody>
                            </table>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="m-p-name" placeholder="æ–°ã—ã„ç‰©ä»¶å" style="flex:1">
                                <button class="primary" onclick="addMProp()">è¿½åŠ </button>
                            </div>
                        </div>
                        <div>
                            <h4>ğŸ·ï¸ ç‰©ä»¶åŒºåˆ† (Lv1) & æ©Ÿç¨®åŒºåˆ† (Lv2)</h4>
                            <p style="font-size:0.8em; color:#64748b;">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">ç‰©ä»¶åŒºåˆ† (Lv1):</label>
                                <textarea id="m-l1-list"
                                    style="width:100%; height:60px; padding:8px; border-radius:6px; border:1px solid #cbd5e1;"></textarea>
                            </div>
                            <div>
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">æ©Ÿç¨®åŒºåˆ† (Lv2):</label>
                                <textarea id="m-l2-list"
                                    style="width:100%; height:80px; padding:8px; border-radius:6px; border:1px solid #cbd5e1;"></textarea>
                            </div>
                            <button class="primary" style="margin-top:10px;"
                                onclick="saveL1L2Masters()">åŒºåˆ†è¨­å®šã‚’ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <div id="sec-l3" class="hidden-view">
                    <h3>ğŸ“‹ å·¥ç¨‹åŒºåˆ†ãƒªã‚¹ãƒˆ (Lv3 ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)</h3>
                    <p style="font-size:0.9em; color:#64748b; margin-bottom:15px;">
                        ç‰©ä»¶ã®ä½œæˆæ™‚ã«ã€ã“ã“ã«ã‚ã‚‹é …ç›®ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ä¸€æ‹¬è¿½åŠ ã§ãã¾ã™ã€‚
                    </p>
                    <table class="m-table">
                        <thead>
                            <tr>
                                <th>å·¥ç¨‹å</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="m-l3-list"></tbody>
                    </table>
                    <div style="display:flex; gap:10px; background:#f8fafc; padding:15px; border-radius:8px;">
                        <input type="text" id="m-l3-name" placeholder="æ–°ã—ã„å·¥ç¨‹å" style="flex:1">
                        <button class="primary" onclick="addMChecklist()">è¿½åŠ </button>
                    </div>
                </div>

                <div id="sec-cloud" class="hidden-view">
                    <div style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0;">
                        <h3>â˜ï¸ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š</h3>
                        <p style="font-size:0.9em; color:#64748b; margin-bottom:15px;">
                            ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã€è¤‡æ•°äººã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™ã€‚<br>
                            ç™ºè¡Œã•ã‚ŒãŸGoogle Apps Scriptã®ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                        </p>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="m-cloud-url"
                                placeholder="https://script.google.com/macros/s/.../exec" style="flex:1">
                            <button class="primary" onclick="saveCloudSettings()">è¨­å®šä¿å­˜</button>
                        </div>
                        <div id="cloud-status" style="font-size:0.9em; color:#64748b;">
                            æœªæ¥ç¶š
                        </div>
                        <hr style="margin:20px 0; border:none; border-top:1px solid #e2e8f0;">
                        <h4>ğŸ› ï¸ è¨­å®šæ‰‹é †</h4>
                        <ol style="font-size:0.9em; line-height:1.6;">
                            <li>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€>ã€ŒApps Scriptã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</li>
                            <li>ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã€‚</li>
                            <li>å³ä¸Šã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€>ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€> ç¨®é¡ã‚’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã«é¸æŠã€‚</li>
                            <li>ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œå…¨å“¡ã€ã«ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚</li>
                            <li>ç™ºè¡Œã•ã‚ŒãŸURLã‚’ä¸Šè¨˜ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œè¨­å®šä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</li>
                        </ol>
                        <textarea id="gas-code" readonly
                            style="width:100%; height:150px; font-family:monospace; font-size:12px; padding:10px; background:#f1f5f9; border:1px solid #cbd5e1; border-radius:4px; margin-top:10px;">
function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const contents = JSON.parse(e.postData.contents);
    const type = contents.type; 
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheets()[0];
    if (type === 'save') {
      sheet.getRange(1, 1).setValue(JSON.stringify(contents.state));
      return ContentService.createTextOutput(JSON.stringify({result: 'success'})).setMimeType(ContentService.MimeType.JSON);
    } else if (type === 'load') {
      const data = sheet.getRange(1, 1).getValue();
      return ContentService.createTextOutput(JSON.stringify({result: 'success', data: data ? JSON.parse(data) : null})).setMimeType(ContentService.MimeType.JSON);
    }
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  return ContentService.createTextOutput("GAS is running. Use POST for data operations.");
}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden-view">
        <div class="header-banner">
            <h1>ğŸ“… å·¥ç¨‹è¡¨ <span style="font-size:0.6em; opacity:0.8; font-weight:normal;" id="version-label"></span></h1>
            <div style="flex:1"></div>
            <div id="user-info-area"
                style="display:flex; align-items:center; gap:15px; font-size:0.9em; background:rgba(255,255,255,0.1); padding:5px 15px; border-radius:20px;">
                <span id="current-user-display"></span>
                <button id="master-btn" style="padding:4px 10px; display:none;"
                    onclick="switchView('master')">ãƒã‚¹ã‚¿ç®¡ç†</button>
                <button style="padding:4px 10px; background:#ef4444; color:white; border:none;"
                    onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        <div class="controls">
            <div class="input-group">
                ğŸ‘€ è¡¨ç¤ºç¯„å›²:
                <input type="date" id="view-start" onchange="updateViewRange()"> ï½
                <input type="date" id="view-end" onchange="updateViewRange()">
            </div>
            <div style="flex:1"></div>
            <button onclick="sortPropertiesByEvent()">ğŸš¨ å„ªå…ˆã‚½ãƒ¼ãƒˆ</button>
            <button onclick="window.location.href='calendar.html'">ğŸ“… äºˆå®šè¡¨ã‚’é–‹ã</button>
            <button onclick="window.addNewProperty()">ğŸ—ï¸ ç‰©ä»¶è¿½åŠ </button>
            <div class="input-group" style="margin-left:10px; border-left:1px solid #cbd5e1; padding-left:10px;">
                ğŸ” <input type="text" id="search-box" placeholder="æ¤œç´¢..." onkeyup="render()">
            </div>
            <div style="margin-left:auto; display:flex; gap:5px;">
                <button onclick="window.toggleAll(true)">é–‹ã</button>
                <button onclick="window.toggleAll(false)">é–‰ã˜ã‚‹</button>
                <button onclick="changeZoom(1.2)">ğŸ”+</button>
                <button onclick="changeZoom(0.8)">ğŸ”-</button>
            </div>
        </div>

        <div class="gantt-wrapper">
            <div class="gantt-list" id="list-panel">
                <div class="list-header-outer" id="list-header-outer">
                    <div class="list-header-content row-container">
                        <div class="cell header col-btn">å‰Šé™¤</div>
                        <div class="cell header col-gouki">å·æ©Ÿ<div class="col-resizer"
                                onmousedown="initColResize(event, 'gouki')"></div>
                        </div>
                        <div class="cell header col-prop">ç‰©ä»¶å<div class="col-resizer"
                                onmousedown="initColResize(event, 'prop')"></div>
                        </div>
                        <div class="cell header col-name">é …ç›®å<div class="col-resizer"
                                onmousedown="initColResize(event, 'name')"></div>
                        </div>
                        <div class="cell header col-date">é–‹å§‹æ—¥<div class="col-resizer"
                                onmousedown="initColResize(event, 'date')"></div>
                        </div>
                        <div class="cell header col-date">çµ‚äº†æ—¥<div class="col-resizer"
                                onmousedown="initColResize(event, 'date')"></div>
                        </div>
                        <div class="cell header col-h">äºˆå®š<div class="col-resizer"
                                onmousedown="initColResize(event, 'h')">
                            </div>
                        </div>
                        <div class="cell header col-h">å®Ÿç¸¾<div class="col-resizer"
                                onmousedown="initColResize(event, 'h')">
                            </div>
                        </div>
                        <div class="cell header col-note">å‚™è€ƒ<div class="col-resizer"
                                onmousedown="initColResize(event, 'note')"></div>
                        </div>
                    </div>
                </div>
                <div class="list-body" id="list-body"></div>
            </div>

            <div class="main-resizer" id="main-resizer"></div>

            <div class="gantt-timeline-panel" id="timeline-panel">
                <div class="timeline-header" id="timeline-header">
                    <div id="header-years" class="header-row"></div>
                    <div id="header-months" class="header-row"></div>
                    <div id="header-days" class="header-row"></div>
                </div>
                <div class="timeline-body" id="timeline-body">
                    <div class="grid-lines" id="grid-lines"></div>
                    <div id="today-line" class="today-line"></div>
                    <div id="rows-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let state = {
            viewStart: null,
            viewEnd: null,
            zoom: 1.0,
            properties: [],
            collapsedIds: new Set(),
            // Auth & Master Data
            currentUser: null,
            masterUsers: [
                { id: 'admin', name: 'ç®¡ç†è€…', role: 'admin', pass: 'fts2531de' },
                { id: 'user', name: 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼', role: 'user', pass: 'user' },
                { id: 'viewer', name: 'é–²è¦§å°‚ç”¨', role: 'viewer', pass: 'viewer' }
            ],
            masterProperties: [], // ç‰©ä»¶åãƒªã‚¹ãƒˆ
            masterL1: ["æ–°ç¯‰", "æ—¢å­˜è‡ªç¤¾å…¥æ›¿", "æ—¢å­˜ä»–ç¤¾å…¥æ›¿"], // ç‰©ä»¶åŒºåˆ†
            masterL2: ["å®…é…", "ãƒã‚¹ã‚¿ã‚¯", "F-charge", "æ—­åŒ–æˆ", "ãƒã‚¹ã‚¿ã‚¯NEO"], // æ©Ÿç¨®åŒºåˆ†
            masterL3: ["ç¾åœ°èª¿æŸ»", "å›³é¢æ‰¿èª", "éƒ¨ææ‰‹é…", "æ–½å·¥"], // å·¥ç¨‹åŒºåˆ†ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç”¨ï¼‰
            // Cloud Sync
            cloudUrl: 'https://script.google.com/macros/s/AKfycbwGPZF5eijcxnpEJh11NHz8_hxf6SVeDzX5vIUdS-IewkjsDDcuP8OwRdkEzWGLCOf0/exec',
            lastSync: null,
            masterTab: 'users'
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatDate = (d) => {
            if (!d || isNaN(d.getTime())) return "";
            const y = d.getFullYear(), m = ('0' + (d.getMonth() + 1)).slice(-2), da = ('0' + d.getDate()).slice(-2);
            return `${y}-${m}-${da}`;
        };
        const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
        const getDiffDays = (d1, d2) => Math.round((d2 - d1) / (1000 * 60 * 60 * 24));

        const parseDate = (val) => {
            if (!val) return null;
            if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
            if (typeof val !== 'string') return null;
            const d = new Date(val.replace(/\//g, '-'));
            return isNaN(d.getTime()) ? null : d;
        };

        const normalizeDate = (val) => {
            const d = parseDate(val);
            return d ? formatDate(d) : "";
        };

        function init() {
            const hardcodedUrl = state.cloudUrl; // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®å›ºå®šURLã‚’é€€é¿
            const saved = loadFromLocalStorage();
            if (saved) {
                state = { ...state, ...saved };
                // ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒç©ºã§ã‚‚ã€å›ºå®šURLãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
                if (hardcodedUrl && !state.cloudUrl) state.cloudUrl = hardcodedUrl;
                // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã®è£œå®Œï¼ˆç§»è¡Œæªç½®ï¼‰
                state.masterUsers.forEach(u => {
                    if (!u.pass) u.pass = (u.id === 'admin') ? 'fts2531de' : u.id;
                });
                // ç‰©ä»¶ãƒã‚¹ã‚¿ã®å½¢å¼å¤‰æ›ï¼ˆç§»è¡Œæªç½®ï¼‰
                if (state.masterProperties && state.masterProperties.length > 0 && typeof state.masterProperties[0] === 'string') {
                    state.masterProperties = state.masterProperties.map(p => ({ name: p, goukis: ["1å·æ©Ÿ"] }));
                }
                state.viewStart = parseDate(state.viewStart) || new Date();
                state.viewEnd = parseDate(state.viewEnd) || new Date();
                state.collapsedIds = new Set(state.collapsedIds || []);
            } else {
                const now = new Date();
                state.viewStart = new Date(now.getFullYear(), now.getMonth(), 1);
                state.viewEnd = new Date(now.getFullYear(), now.getMonth() + 6, 0);
                state.properties.push({ id: generateId(), name: state.masterProperties[0], gouki: "1å·æ©Ÿ", categories: [] });
            }
            document.getElementById('view-start').value = formatDate(state.viewStart);
            document.getElementById('view-end').value = formatDate(state.viewEnd);
            document.getElementById('version-label').textContent = document.title;

            if (state.currentUser) {
                switchView('gantt');
            } else {
                switchView('login');
            }

            setupScrollSync();
            setupMainResizer();

            if (state.cloudUrl) syncFromCloud();
        }

        // --- Auth & View Logic ---
        function doLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            const user = state.masterUsers.find(u => u.id === id && u.pass === pass);
            if (user) {
                state.currentUser = user;
                document.getElementById('login-error').style.display = 'none';
                saveToLocalStorage();
                switchView('gantt');
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function doLogout() {
            state.currentUser = null;
            saveToLocalStorage();
            switchView('login');
        }

        function switchView(v) {
            document.getElementById('login-screen').style.display = (v === 'login') ? 'flex' : 'none';
            document.getElementById('master-screen').style.display = (v === 'master') ? 'flex' : 'none';
            document.getElementById('main-app').classList.toggle('hidden-view', v !== 'gantt' && v !== 'master');

            if (v === 'gantt') render();
            if (v === 'master') {
                if (!state.masterTab) state.masterTab = 'users'; // Set default
                renderMaster();
            }
        }

        window.switchMasterTab = (t) => {
            state.masterTab = t;
            renderMaster();
        };

        function renderMaster() {
            // Update Tab UI
            document.querySelectorAll('.m-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${state.masterTab}`).classList.add('active');

            // Update Section UI
            document.getElementById('sec-users').classList.toggle('hidden-view', state.masterTab !== 'users');
            document.getElementById('sec-props').classList.toggle('hidden-view', state.masterTab !== 'props');
            document.getElementById('sec-l3').classList.toggle('hidden-view', state.masterTab !== 'l3');
            document.getElementById('sec-cloud').classList.toggle('hidden-view', state.masterTab !== 'cloud');

            if (state.masterTab === 'users') {
                const uBody = document.getElementById('m-user-list');
                uBody.innerHTML = state.masterUsers.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td><input type="text" value="${u.name}" onchange="updMUser('${u.id}','name',this.value)"></td>
                        <td><input type="text" value="${u.pass}" onchange="updMUser('${u.id}','pass',this.value)"></td>
                        <td>
                            <select onchange="updMUser('${u.id}','role',this.value)">
                                <option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
                                <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>viewer</option>
                                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
                            </select>
                        </td>
                        <td>${u.id !== 'admin' ? `<button class="danger" onclick="delMUser('${u.id}')">å‰Šé™¤</button>` : ''}</td>
                    </tr>
                `).join('');
            } else if (state.masterTab === 'props') {
                const pBody = document.getElementById('m-prop-list');
                pBody.innerHTML = state.masterProperties.map((p, i) => `
                    <tr>
                        <td><input type="text" value="${p.name || p}" onchange="updMProp(${i},'name',this.value)"></td>
                        <td><button class="danger" onclick="delMProp(${i})">å‰Šé™¤</button></td>
                    </tr>
                `).join('');
                document.getElementById('m-l1-list').value = state.masterL1.join(', ');
                document.getElementById('m-l2-list').value = state.masterL2.join(', ');
            } else if (state.masterTab === 'l3') {
                const lBody = document.getElementById('m-l3-list');
                lBody.innerHTML = (state.masterL3 || []).map((item, i) => `
                    <tr>
                        <td><input type="text" value="${item}" onchange="updML3(${i},this.value)" style="width:100%"></td>
                        <td><button class="danger" onclick="delML3(${i})">å‰Šé™¤</button></td>
                    </tr>
                `).join('');
            } else if (state.masterTab === 'cloud') {
                document.getElementById('m-cloud-url').value = state.cloudUrl || '';
                const st = document.getElementById('cloud-status');
                if (state.cloudUrl) {
                    st.innerHTML = `æ¥ç¶šå…ˆè¨­å®šæ¸ˆã¿ (æœ€çµ‚åŒæœŸ: ${state.lastSync ? state.lastSync : 'æœªåŒæœŸ'})<br>
                                   <button onclick="syncFromCloud()" style="margin-top:5px; font-size:0.8em;">â˜ï¸ ä»Šã™ãã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
                                   <button onclick="syncToCloud()" style="margin-top:5px; font-size:0.8em;">â˜ï¸ ä»Šã™ãã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜ã™ã‚‹</button>`;
                } else {
                    st.innerText = 'æœªæ¥ç¶š';
                }
            }
        }

        window.saveCloudSettings = () => {
            const url = document.getElementById('m-cloud-url').value;
            state.cloudUrl = url;
            saveToLocalStorage();
            renderMaster();
            alert('ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            if (url) syncFromCloud();
        };

        async function syncToCloud() {
            if (!state.cloudUrl) return;
            try {
                const dataToSave = { ...state, collapsedIds: Array.from(state.collapsedIds) };
                const resp = await fetch(state.cloudUrl, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'save', state: dataToSave })
                });
                const res = await resp.json();
                if (res.result === 'success') {
                    state.lastSync = new Date().toLocaleString();
                    saveToLocalStorage();
                    renderMaster();
                    console.log('Cloud sync success');
                }
            } catch (e) { console.error('Cloud sync failed', e); }
        }

        async function syncFromCloud() {
            if (!state.cloudUrl) return;
            try {
                const resp = await fetch(state.cloudUrl, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'load' })
                });
                const res = await resp.json();
                if (res.result === 'success' && res.data) {
                    const cloudState = res.data;
                    const currentUrl = state.cloudUrl; // ç¾åœ¨ã®æ¥ç¶šå…ˆã‚’ä¿æŒ
                    state = { ...state, ...cloudState };
                    state.cloudUrl = currentUrl; // æ¥ç¶šå…ˆè¨­å®šãŒç©ºãƒ‡ãƒ¼ã‚¿ãªã©ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã‚’é˜²ã
                    state.viewStart = parseDate(state.viewStart) || new Date();
                    state.viewEnd = parseDate(state.viewEnd) || new Date();
                    state.collapsedIds = new Set(state.collapsedIds || []);
                    state.lastSync = new Date().toLocaleString();

                    // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚“ã ç›´å¾Œã«ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰ã™ã‚‹ã®ã‚’é˜²ã
                    const dataToSave = { ...state, collapsedIds: Array.from(state.collapsedIds) };
                    localStorage.setItem('gantt_state', JSON.stringify(dataToSave));

                    render();
                    if (document.getElementById('master-screen').style.display === 'flex') renderMaster();
                    console.log('Cloud data loaded successfully');
                }
            } catch (e) {
                console.error('Cloud load failed', e);
                alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        window.updMUser = (id, k, v) => {
            const u = state.masterUsers.find(x => x.id === id);
            if (u) u[k] = v;
            saveToLocalStorage();
        };
        window.updMProp = (i, k, v) => {
            state.masterProperties[i][k] = v;
            saveToLocalStorage();
        };

        window.addMUser = () => {
            const id = document.getElementById('m-u-id').value,
                name = document.getElementById('m-u-name').value,
                pass = document.getElementById('m-u-pass').value,
                role = document.getElementById('m-u-role').value;
            if (!id || !name || !pass) return alert('IDã€åå‰ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (state.masterUsers.find(u => u.id === id)) return alert('æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹IDã§ã™');
            state.masterUsers.push({ id, name, pass, role });
            saveToLocalStorage(); renderMaster();
            document.getElementById('m-u-id').value = '';
            document.getElementById('m-u-name').value = '';
            document.getElementById('m-u-pass').value = '';
        };
        window.delMUser = (id) => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { state.masterUsers = state.masterUsers.filter(u => u.id !== id); saveToLocalStorage(); renderMaster(); } };
        window.addMProp = () => {
            const name = document.getElementById('m-p-name').value;
            if (!name) return;
            state.masterProperties.push({ name });
            saveToLocalStorage(); renderMaster();
            document.getElementById('m-p-name').value = '';
        };

        window.saveL1L2Masters = () => {
            const l1Str = document.getElementById('m-l1-list').value;
            const l2Str = document.getElementById('m-l2-list').value;
            state.masterL1 = l1Str.split(',').map(s => s.trim()).filter(s => s);
            state.masterL2 = l2Str.split(',').map(s => s.trim()).filter(s => s);
            saveToLocalStorage();
            alert('ç‰©ä»¶åŒºåˆ†ãƒ»æ©Ÿç¨®åŒºåˆ†ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            renderMaster();
        };

        window.addMChecklist = () => {
            const name = document.getElementById('m-l3-name').value;
            if (!name) return;
            state.masterL3.push(name);
            saveToLocalStorage(); renderMaster();
            document.getElementById('m-l3-name').value = '';
        };

        window.updML3 = (i, v) => {
            state.masterL3[i] = v;
            saveToLocalStorage();
        };

        window.delML3 = (i) => {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                state.masterL3.splice(i, 1);
                saveToLocalStorage(); renderMaster();
            }
        };

        window.importMasterCSV = () => document.getElementById('m-csv-file').click();
        window.handleMasterCSV = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
                if (lines.length === 0) return;
                // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ¤å®šã¨ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
                // å½¢å¼1: user,ID,Name,Pass,Role
                // å½¢å¼2: prop,Name,Goukis(comma separated)
                lines.forEach(line => {
                    const parts = parseCSVLine(line);
                    if (parts[0] === 'user' && parts.length >= 5) {
                        const existing = state.masterUsers.find(u => u.id === parts[1]);
                        if (existing) { existing.name = parts[2]; existing.pass = parts[3]; existing.role = parts[4]; }
                        else { state.masterUsers.push({ id: parts[1], name: parts[2], pass: parts[3], role: parts[4] }); }
                    } else if (parts[0] === 'prop' && parts.length >= 3) {
                        const existing = state.masterProperties.find(p => p.name === parts[1]);
                        const goukis = parts[2].split('|').map(s => s.trim()).filter(s => s); // CSVå†…ã¯|åŒºåˆ‡ã‚Šã‚’æƒ³å®š
                        if (existing) { existing.goukis = goukis; }
                        else { state.masterProperties.push({ name: parts[1], goukis }); }
                    }
                });
                saveToLocalStorage(); renderMaster();
                alert('ãƒã‚¹ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            };
            reader.readAsText(file);
            input.value = '';
        };
        window.delMProp = (i) => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { state.masterProperties.splice(i, 1); saveToLocalStorage(); renderMaster(); } };

        function saveToLocalStorage() {
            const dataToSave = { ...state, collapsedIds: Array.from(state.collapsedIds) };
            localStorage.setItem('gantt_state', JSON.stringify(dataToSave));
            if (state.cloudUrl) syncToCloud();
        }

        function loadFromLocalStorage() {
            const json = localStorage.getItem('gantt_state');
            if (!json) return null;
            try { return JSON.parse(json); } catch (e) { return null; }
        }

        function calculateRollups(p) {
            let pMin = null, pMax = null;
            let tPlan = 0, tAct = 0;

            const processNode = (node) => {
                if (!node) return;
                const st = parseDate(node.start), ed = parseDate(node.end);
                if (st && (!pMin || st < pMin)) pMin = st;
                if (ed && (!pMax || ed > pMax)) pMax = ed;
            };

            processNode(p.l1);
            processNode(p.l2);

            (p.items || []).forEach(item => {
                tPlan += parseFloat(item.planH) || 0;
                tAct += parseFloat(item.actH) || 0;
                (item.dates || []).forEach(dS => {
                    const d = parseDate(dS);
                    if (d && (!pMin || d < pMin)) pMin = d;
                    if (d && (!pMax || d > pMax)) pMax = d;
                });
            });

            p.autoStart = pMin ? formatDate(pMin) : "";
            p.autoEnd = pMax ? formatDate(pMax) : "";
            p.totalPlanH = tPlan;
            p.totalActH = tAct;
        }

        function render() {
            if (!state.currentUser) return switchView('login');
            document.documentElement.style.setProperty('--zoom', state.zoom);

            // Update Top UI
            document.getElementById('current-user-display').textContent = `ğŸ‘¤ ${state.currentUser.name} (${state.currentUser.role})`;
            document.getElementById('master-btn').style.display = state.currentUser.role === 'admin' ? 'block' : 'none';

            renderHeader();
            renderBody();
        }

        function renderHeader() {
            const hY = document.getElementById('header-years'), hM = document.getElementById('header-months'), hD = document.getElementById('header-days');
            const tH = document.getElementById('timeline-header');
            hY.innerHTML = hM.innerHTML = hD.innerHTML = '';
            const start = new Date(state.viewStart), end = new Date(state.viewEnd);
            const dw = 30 * state.zoom;
            const daysCount = getDiffDays(start, end) + 1, totalW = daysCount * dw;

            tH.style.width = hY.style.width = hM.style.width = hD.style.width = totalW + 'px';
            document.getElementById('timeline-body').style.width = totalW + 'px';

            const gl = document.getElementById('grid-lines');
            gl.style.background = `linear-gradient(90deg, #e2e8f0 1px, transparent 1px) 0 0 / ${dw}px 100%`;

            let curY = -1, curM = -1, yC = null, mC = null, dY = 0, dM = 0;
            const tStr = formatDate(new Date());
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const y = d.getFullYear(), m = d.getMonth(), dS = formatDate(d);
                if (y !== curY) { if (yC) yC.style.width = (dY * dw) + 'px'; yC = document.createElement('div'); yC.className = 'header-cell'; yC.textContent = y + 'å¹´'; hY.appendChild(yC); curY = y; dY = 0; } dY++;
                if (m !== curM || y !== curY) { if (mC) mC.style.width = (dM * dw) + 'px'; mC = document.createElement('div'); mC.className = 'header-cell'; mC.textContent = (m + 1) + 'æœˆ'; hM.appendChild(mC); curM = m; dM = 0; } dM++;
                const dCell = document.createElement('div'); dCell.className = 'header-cell day'; const wd = d.getDay();
                if (wd === 0) dCell.classList.add('holiday'); else if (wd === 6) dCell.classList.add('saturday');
                if (dS === tStr) dCell.classList.add('today-hl');
                dCell.innerHTML = `<span>${d.getDate()}</span><span style="font-size:0.7em">${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][wd]}</span>`;
                dCell.style.width = dw + 'px'; hD.appendChild(dCell);
            }
            if (yC) yC.style.width = (dY * dw) + 'px'; if (mC) mC.style.width = (dM * dw) + 'px';

            const tL = document.getElementById('today-line');
            const now = new Date();
            const startStr = formatDate(start);

            if (tStr >= startStr && tStr <= formatDate(end)) {
                tL.style.display = 'block';
                // Calculate exact column index by counting days from start (Local)
                const sTemp = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                const nTemp = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const diffDays = Math.round((nTemp - sTemp) / (1000 * 60 * 60 * 24));
                tL.style.left = (diffDays * dw) + 'px';
            } else { tL.style.display = 'none'; }
        }

        function renderBody() {
            const lB = document.getElementById('list-body'), tC = document.getElementById('rows-container');
            lB.innerHTML = tC.innerHTML = '';
            const query = document.getElementById('search-box').value.toLowerCase();

            state.properties.forEach(p => {
                // Ensure data structure (Migration/Fix)
                if (!p.l1) p.l1 = { id: generateId(), name: state.masterL1[0], start: formatDate(new Date()), end: formatDate(new Date()) };
                if (!p.l2) p.l2 = { id: generateId(), name: state.masterL2[0], start: formatDate(new Date()), end: formatDate(new Date()) };
                if (!p.items) p.items = [];

                calculateRollups(p);

                // p: Item (Level 0)
                const pMatch = p.name.toLowerCase().includes(query) || (p.note && p.note.toLowerCase().includes(query));
                if (!pMatch && query && !p.l1?.name.toLowerCase().includes(query)) return;

                // Render ç‰©ä»¶ (Lv0)
                const r0 = createRow('prop-row', p, 'p', p.id); lB.appendChild(r0.list); tC.appendChild(r0.time);
                const b0 = createBar({ name: p.name, start: p.autoStart, end: p.autoEnd }, 'prop'); if (b0) r0.time.appendChild(b0);

                if (!state.collapsedIds.has(p.id)) {
                    // Render ç‰©ä»¶åŒºåˆ† (Lv1) - Exactly ONE
                    const r1 = createRow('cat-row', p.l1, 'l1', p.id); lB.appendChild(r1.list); tC.appendChild(r1.time);
                    const b1 = createBar(p.l1, 'summary'); if (b1) r1.time.appendChild(b1);

                    if (!state.collapsedIds.has(p.l1.id)) {
                        // Render æ©Ÿç¨®åŒºåˆ† (Lv2) - Exactly ONE
                        const r2 = createRow('cat-row', p.l2, 'l2', p.id); lB.appendChild(r2.list); tC.appendChild(r2.time);
                        const b2 = createBar(p.l2, 'summary'); if (b2) r2.time.appendChild(b2);

                        if (!state.collapsedIds.has(p.l2.id)) {
                            // Render å·¥ç¨‹åŒºåˆ† (Lv3) - Multiple
                            (p.items || []).forEach(l3 => {
                                const r3 = createRow('task-row', l3, 'l3', p.id); lB.appendChild(r3.list); tC.appendChild(r3.time);
                                renderL3Bars(l3, r3.time);
                            });
                        }
                    }
                }
            });
        }

        function createRow(type, data, lv, pI) {
            const list = document.createElement('div'); list.className = `row-container ${type}`;
            const time = document.createElement('div'); time.className = `row-container ${type}`;
            const isCol = state.collapsedIds.has(data.id);
            const toggleIcon = `<span class="folder-toggle ${isCol ? 'collapsed' : ''}" onclick="window.toggleCollapse('${data.id}')">â–¼</span>`;
            const canEdit = state.currentUser?.role !== 'viewer';
            const dis = canEdit ? '' : 'disabled';

            if (lv === 'p') {
                const optPropHtml = state.masterProperties.map(p => `<option value="${p.name}" ${data.name === p.name ? 'selected' : ''}>${p.name}</option>`).join('');
                list.innerHTML = `
                    <div class="cell col-btn"><button class="danger" onclick="window.delP('${data.id}')" ${dis}>Ã—</button></div>
                    <div class="cell col-gouki"></div>
                    <div class="cell col-prop">${toggleIcon}<select onchange="upd('${data.id}','name',this.value,'p')" ${dis}>${optPropHtml}</select></div>
                    <div class="cell col-name"></div>
                    <div class="cell col-date">${data.autoStart || "--"}</div><div class="cell col-date">${data.autoEnd || "--"}</div>
                    <div class="cell col-h">${data.totalPlanH || 0}</div>
                    <div class="cell col-h">${data.totalActH || 0}</div>
                    <div class="cell col-note"><input type="text" value="${data.note || ''}" onchange="upd('${data.id}','note',this.value,'p')" ${dis} placeholder="ç‰©ä»¶å‚™è€ƒ..."></div>
                `;
            } else if (lv === 'l1') {
                const optL1 = state.masterL1.map(v => `<option value="${v}" ${data.name === v ? 'selected' : ''}>${v}</option>`).join('');
                list.innerHTML = `
                    <div class="cell col-btn"></div>
                    <div class="cell col-gouki"></div><div class="cell col-prop"></div>
                    <div class="cell col-name"><div style="padding-left:15px;display:flex;align-items:center;width:100%">${toggleIcon}<select onchange="upd('${data.id}','name',this.value,'l1','${pI}')" ${dis}>${optL1}</select></div></div>
                    <div class="cell col-date"><input type="date" value="${data.start}" onchange="upd('${data.id}','start',this.value,'l1','${pI}')" ${dis}></div>
                    <div class="cell col-date"><input type="date" value="${data.end}" onchange="upd('${data.id}','end',this.value,'l1','${pI}')" ${dis}></div>
                    <div class="cell col-h"></div><div class="cell col-h"></div><div class="cell col-note"></div>
                `;
            } else if (lv === 'l2') {
                const optL2 = state.masterL2.map(v => `<option value="${v}" ${data.name === v ? 'selected' : ''}>${v}</option>`).join('');
                list.innerHTML = `
                    <div class="cell col-btn"></div>
                    <div class="cell col-gouki"></div><div class="cell col-prop"></div>
                    <div class="cell col-name"><div style="padding-left:30px;display:flex;align-items:center;width:100%">${toggleIcon}<select onchange="upd('${data.id}','name',this.value,'l2','${pI}')" ${dis}>${optL2}</select><button onclick="window.openItemModal('${pI}')" style="margin-left:5px" ${dis}>ï¼‹å·¥ç¨‹</button></div></div>
                    <div class="cell col-date"><input type="date" value="${data.start}" onchange="upd('${data.id}','start',this.value,'l2','${pI}')" ${dis}></div>
                    <div class="cell col-date"><input type="date" value="${data.end}" onchange="upd('${data.id}','end',this.value,'l2','${pI}')" ${dis}></div>
                    <div class="cell col-h"></div><div class="cell col-h"></div><div class="cell col-note"></div>
                `;
            } else {
                // Level 3: Advanced Task with 10 slots
                const dateInputs = (data.dates || []).map((d, idx) => `<input type="date" value="${d}" onchange="updL3Date('${pI}','${data.id}',${idx},this.value)" style="width:110px; margin-right:2px;" ${dis}>`).join('');
                const addDateBtn = (data.dates || []).length < 10 ? `<button onclick="addL3Date('${pI}','${data.id}')" ${dis}>+</button>` : '';

                const status = getL3Status(data);
                let statusColor = '#94a3b8'; // gray
                if (status === 'overdue') statusColor = '#ef4444'; // red
                else if (status === 'incomplete') statusColor = '#eab308'; // yellow

                list.innerHTML = `
                    <div class="cell col-btn"><button class="danger" onclick="window.delL3('${pI}','${data.id}')" ${dis}>Ã—</button></div>
                    <div class="cell col-gouki"><div style="width:15px; height:15px; border-radius:50%; background:${statusColor};" title="${status}"></div></div>
                    <div class="cell col-prop"></div>
                    <div class="cell col-name"><div style="padding-left:45px;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${data.name}">${data.name}</div></div>
                    <div class="cell" style="flex:1; min-width:300px; display:flex; align-items:center; overflow-x:auto;">
                        ${dateInputs} ${addDateBtn}
                    </div>
                    <div class="cell col-h" style="width:60px; flex:0 0 60px;"><input type="number" step="0.5" value="${data.planH || 0}" onchange="upd('${data.id}','planH',this.value,'l3','${pI}')" style="width:45px" ${dis}></div>
                    <div class="cell col-h" style="width:60px; flex:0 0 60px;"><input type="number" step="0.5" value="${data.actH || 0}" onchange="upd('${data.id}','actH',this.value,'l3','${pI}')" style="width:45px" ${dis}></div>
                    <div class="cell col-note"><input type="text" value="${data.note || ''}" onchange="upd('${data.id}','note',this.value,'l3','${pI}')" ${dis}></div>
                `;
            }
            return { list, time };
        }

        function renderL3Bars(l3, container) {
            const vS = parseDate(state.viewStart);
            if (!vS || !l3.dates) return;
            const dw = 30 * state.zoom;

            l3.dates.forEach(dS => {
                const date = parseDate(dS);
                if (!date) return;
                const bar = document.createElement('div');
                bar.className = 'task-bar milestone';
                bar.style.left = (getDiffDays(vS, date) * dw + (dw / 2)) + 'px';

                const lbl = document.createElement('span');
                lbl.className = 'milestone-label';
                lbl.innerText = l3.name;
                bar.appendChild(lbl);
                container.appendChild(bar);
            });
        }

        function createBar(t, cls) {
            const vS = parseDate(state.viewStart), tS = parseDate(t.start), tE = parseDate(t.end);
            if (!vS || (!tS && !tE)) return null;

            const dw = 30 * state.zoom;
            const bar = document.createElement('div');

            // Detection logic: Milestone if only one date or both same day
            const isMilestone = !cls && (!tS || !tE || getDiffDays(tS, tE) === 0);

            if (isMilestone) {
                const targetDate = tS || tE;
                bar.className = `task-bar milestone`;
                bar.style.left = (getDiffDays(vS, targetDate) * dw + (dw / 2)) + 'px';

                const lbl = document.createElement('span');
                lbl.className = 'milestone-label';
                lbl.innerText = t.name || "";
                bar.appendChild(lbl);
            } else {
                if (!tS || !tE || tE < tS) return null;
                bar.className = `task-bar ${cls}`;
                bar.style.left = (getDiffDays(vS, tS) * dw) + 'px';
                bar.style.width = ((getDiffDays(tS, tE) + 1) * dw) + 'px';
                bar.innerText = t.name || "";

                if (!cls) {
                    bar.onmousedown = (e) => initBarDrag(e, t, 'move');
                    const hL = document.createElement('div'); hL.className = 'bar-handle left'; hL.onmousedown = (e) => { e.stopPropagation(); initBarDrag(e, t, 'left'); };
                    const hR = document.createElement('div'); hR.className = 'bar-handle right'; hR.onmousedown = (e) => { e.stopPropagation(); initBarDrag(e, t, 'right'); };
                    bar.appendChild(hL); bar.appendChild(hR);
                }
            }
            return bar;
        }

        window.initColResize = (e, key) => {
            e.stopPropagation();
            let sX = e.clientX;
            let iW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue(`--col-${key}-base`));
            const mv = (me) => {
                const diff = (me.clientX - sX) / state.zoom;
                document.documentElement.style.setProperty(`--col-${key}-base`, (iW + diff) + 'px');
            };
            const up = () => { window.removeEventListener('mousemove', mv); window.removeEventListener('mouseup', up); };
            window.addEventListener('mousemove', mv); window.addEventListener('mouseup', up);
        };

        window.toggleCollapse = (id) => { if (state.collapsedIds.has(id)) state.collapsedIds.delete(id); else state.collapsedIds.add(id); saveToLocalStorage(); render(); };
        window.toggleAll = (exp) => {
            state.collapsedIds.clear();
            if (!exp) {
                state.properties.forEach(p => {
                    state.collapsedIds.add(p.id);
                    if (p.l1) state.collapsedIds.add(p.l1.id);
                    if (p.l2) state.collapsedIds.add(p.l2.id);
                });
            }
            saveToLocalStorage(); render();
        };
        window.changeZoom = (f) => { state.zoom = Math.max(0.3, Math.min(3.0, state.zoom * f)); saveToLocalStorage(); render(); };

        window.upd = (id, k, v, lv, pI) => {
            if (state.currentUser?.role === 'viewer') return;
            const p = state.properties.find(x => x.id === (lv === 'p' ? id : pI));
            if (!p) return;

            if (lv === 'p') {
                p[k] = v;
            } else if (lv === 'l1') {
                if (p.l1) p.l1[k] = v;
            } else if (lv === 'l2') {
                if (p.l2) p.l2[k] = v;
            } else if (lv === 'l3') {
                const l3 = p.items.find(x => x.id === id);
                if (l3) l3[k] = v;
            }
            saveToLocalStorage(); render();
        };

        window.addNewProperty = () => {
            if (state.currentUser?.role === 'viewer') return;
            const today = formatDate(new Date());
            state.properties.push({
                id: generateId(),
                name: state.masterProperties[0]?.name || "æ–°è¦ç‰©ä»¶",
                l1: { id: generateId(), name: state.masterL1[0], start: today, end: today },
                l2: { id: generateId(), name: state.masterL2[0], start: today, end: today },
                items: []
            });
            saveToLocalStorage(); render();
        };

        window.updL3Date = (pI, l3I, idx, v) => {
            const p = state.properties.find(x => x.id === pI), l3 = p?.items?.find(x => x.id === l3I);
            if (l3 && l3.dates) {
                l3.dates[idx] = v;
                saveToLocalStorage(); render();
            }
        };
        window.addL3Date = (pI, l3I) => {
            const p = state.properties.find(x => x.id === pI), l3 = p?.items?.find(x => x.id === l3I);
            if (l3) {
                if (!l3.dates) l3.dates = [];
                if (l3.dates.length < 10) {
                    l3.dates.push(formatDate(new Date()));
                    saveToLocalStorage(); render();
                }
            }
        };

        window.delP = (id) => { if (confirm("ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { state.properties = state.properties.filter(x => x.id !== id); saveToLocalStorage(); render(); } };
        window.delL3 = (pI, id) => { if (confirm("å·¥ç¨‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { const p = state.properties.find(x => x.id === pI); if (p) p.items = p.items.filter(x => x.id !== id); saveToLocalStorage(); render(); } };

        let currentModalContext = null;
        window.openItemModal = (pI) => {
            currentModalContext = { pI };
            const container = document.getElementById('modal-checklist-container');
            container.innerHTML = state.masterL3.map(item => `
                <div class="checklist-item">
                    <input type="checkbox" data-name="${item}" id="chk-${item}">
                    <label for="chk-${item}">${item}</label>
                </div>
            `).join('');
            document.getElementById('item-modal').style.display = 'flex';
        };

        window.closeItemModal = () => {
            document.getElementById('item-modal').style.display = 'none';
        };

        window.addSelectedItems = () => {
            if (!currentModalContext) return;
            const { pI } = currentModalContext;
            const p = state.properties.find(x => x.id === pI);
            if (!p) return;

            const selected = Array.from(document.querySelectorAll('#modal-checklist-container input:checked')).map(cb => cb.dataset.name);
            selected.forEach(name => {
                if (!p.items) p.items = [];
                p.items.push({ id: generateId(), name, dates: [], note: "" });
            });
            saveToLocalStorage(); render(); closeItemModal();
        };

        window.sortPropertiesByEvent = () => {
            state.properties.sort((a, b) => {
                const aScore = getPriorityScore(a);
                const bScore = getPriorityScore(b);
                return bScore - aScore;
            });
            render();
            alert('å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆæœªå®Œäº†ãƒ»æœŸé™åˆ‡ã‚Œé …ç›®ãŒå¤šã„é †ï¼‰');
        };

        function getPriorityScore(p) {
            let score = 0;
            (p.items || []).forEach(l3 => {
                const status = getL3Status(l3);
                if (status === 'overdue') score += 10;
                else if (status === 'incomplete') score += 1;
            });
            return score;
        }

        function getL3Status(l3) {
            const todayStr = formatDate(new Date());
            const hasDates = (l3.dates || []).filter(d => d).length > 0;

            if (!hasDates) {
                // If no dates are set, it's incomplete
                return 'incomplete';
            }

            // Check if any date is in the future
            const hasFutureDates = (l3.dates || []).some(d => {
                const date = parseDate(d);
                return date && formatDate(date) > todayStr;
            });

            if (hasFutureDates) {
                // If there's at least one future date, it's still in progress or planned
                return 'done'; // Or 'in-progress' if we want more granularity
            }

            // If all dates are in the past or today, and there are dates, it's considered done
            // If we want to mark as 'overdue' if all dates are past and no future dates,
            // but the task is not "completed" (e.g., no actual completion date), we need a 'completed' flag.
            // For now, if dates exist and none are future, it's 'done'.
            return 'done';
        }

        function updateViewRange() { state.viewStart = new Date(document.getElementById('view-start').value); state.viewEnd = new Date(document.getElementById('view-end').value); saveToLocalStorage(); render(); }

        function setupScrollSync() {
            const lb = document.getElementById('list-body'), lho = document.getElementById('list-header-outer'), tp = document.getElementById('timeline-panel');
            lb.onscroll = () => { tp.scrollTop = lb.scrollTop; lho.scrollLeft = lb.scrollLeft; };
            tp.onscroll = () => { lb.scrollTop = tp.scrollTop; };
            let isDown = false, sX, sY, sl, st;
            lb.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.classList.contains('col-resizer')) return;
                isDown = true; lb.style.cursor = 'grabbing';
                sX = e.pageX - lb.offsetLeft; sY = e.pageY - lb.offsetTop;
                sl = lb.scrollLeft; st = lb.scrollTop;
            });
            window.addEventListener('mouseup', () => { if (isDown) { isDown = false; lb.style.cursor = 'auto'; } });
            window.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                const x = e.pageX - lb.offsetLeft; const y = e.pageY - lb.offsetTop;
                lb.scrollLeft = sl - (x - sX) * 1.5;
                lb.scrollTop = st - (y - sY) * 1.5;
            });
        }

        function setupMainResizer() {
            const r = document.getElementById('main-resizer');
            let isD = false;
            r.onmousedown = (e) => { isD = true; document.body.style.cursor = 'col-resize'; document.body.style.userSelect = 'none'; e.preventDefault(); };
            window.addEventListener('mousemove', (e) => {
                if (!isD) return;
                const rect = document.querySelector('.gantt-wrapper').getBoundingClientRect();
                document.documentElement.style.setProperty('--list-viewport-w', (e.clientX - rect.left) + 'px');
            });
            window.addEventListener('mouseup', () => { isD = false; document.body.style.cursor = ''; document.body.style.userSelect = 'auto'; });
        }

        function initBarDrag(e, t, m) {
            if (state.currentUser?.role === 'viewer') return;
            let sX = e.clientX, iS = new Date(t.start), iE = new Date(t.end);
            const dw = 30 * state.zoom;
            function mv(me) {
                const d = Math.round((me.clientX - sX) / dw); if (d === 0) return;
                if (m === 'move') { const ns = addDays(iS, d), dr = getDiffDays(iS, iE); t.start = formatDate(ns); t.end = formatDate(addDays(ns, dr)); }
                else if (m === 'left') { const ns = addDays(iS, d); if (ns <= new Date(t.end)) t.start = formatDate(ns); }
                else { const ne = addDays(iE, d); if (ne >= new Date(t.start)) t.end = formatDate(ne); }
                render();
            }
            function up() { window.removeEventListener('mousemove', mv); window.removeEventListener('mouseup', up); }
            window.addEventListener('mousemove', mv); window.addEventListener('mouseup', up);
        }

        function saveData() {
            const rows = [['L1_ID', 'Gouki', 'PropName', 'PropNote', 'L1_Name', 'L1_Start', 'L1_End', 'L2_Name', 'L2_Start', 'L2_End', 'L3_Name', 'L3_Dates', 'L3_Note', 'L3_PlanH', 'L3_ActH']];
            state.properties.forEach(p => {
                if (!p.items || p.items.length === 0) {
                    rows.push([p.id, p.gouki || "", p.name, p.note || "", p.l1.name, p.l1.start, p.l1.end, p.l2.name, p.l2.start, p.l2.end, '', '', '', '', '']);
                } else {
                    p.items.forEach(t => {
                        rows.push([p.id, p.gouki || "", p.name, p.note || "", p.l1.name, p.l1.start, p.l1.end, p.l2.name, p.l2.start, p.l2.end, t.name, (t.dates || []).join('|'), t.note || "", t.planH || 0, t.actH || 0]);
                    });
                }
            });
            const csv = "\uFEFF" + rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `gantt_schedule_${new Date().getTime()}.csv`; link.click();
        }

        function parseCSVLine(line) {
            const result = []; let cur = '', inQ = false;
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                if (c === '"') { if (inQ && line[i + 1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
                else if (c === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
                else cur += c;
            }
            result.push(cur.trim()); return result;
        }

        function loadData(ev) {
            const f = ev.target.files[0]; if (!f) return;
            const r = new FileReader(); r.onload = (e) => {
                const rawLines = e.target.result.split(/\r?\n/).filter(l => l.trim());
                if (rawLines.length < 2) return;
                const lines = rawLines.slice(1).map(parseCSVLine);
                const props = []; const pM = new Map();
                lines.forEach(cols => {
                    let pI, gk, pN, pNt, l1N, l1S, l1E, l2N, l2S, l2E, l3N, l3D, l3Nt, l3P, l3A;
                    if (cols.length >= 15) [pI, gk, pN, pNt, l1N, l1S, l1E, l2N, l2S, l2E, l3N, l3D, l3Nt, l3P, l3A] = cols;
                    else if (cols.length >= 12) { [pI, gk, pN, , l1N, l1S, l1E, l2N, l2S, l2E, l3N, l3D, l3Nt, l3P, l3A] = cols; } // Handle variations if any
                    else return;

                    pI = pI || "P_" + generateId();
                    if (!pM.has(pI)) {
                        const p = {
                            id: pI, gouki: gk || "", name: pN || "", note: pNt || "",
                            l1: { id: generateId(), name: l1N || state.masterL1[0], start: normalizeDate(l1S), end: normalizeDate(l1E) },
                            l2: { id: generateId(), name: l2N || state.masterL2[0], start: normalizeDate(l2S), end: normalizeDate(l2E) },
                            items: []
                        };
                        pM.set(pI, p); props.push(p);
                    }
                    if (l3N) {
                        const p = pM.get(pI);
                        p.items.push({
                            id: generateId(), name: l3N, dates: (l3D || "").split('|').filter(x => x),
                            note: l3Nt || "", planH: parseFloat(l3P) || 0, actH: parseFloat(l3A) || 0
                        });
                    }
                });
                if (props.length) { state.properties = props; state.collapsedIds.clear(); saveToLocalStorage(); render(); }
            }; r.readAsText(f);
        }

        init();
    </script>

    <!-- å·¥ç¨‹è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="item-modal" class="modal-overlay">
        <div class="modal-body">
            <div class="modal-header">
                <div class="modal-title">å·¥ç¨‹ã‚’é¸æŠã—ã¦è¿½åŠ </div>
                <button class="close-btn" onclick="closeItemModal()">Ã—</button>
            </div>
            <div id="modal-checklist-container">
                <!-- Checklist items injected by JS -->
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="primary" onclick="addSelectedItems()">é¸æŠã—ãŸé …ç›®ã‚’è¿½åŠ </button>
            </div>
        </div>
    </div>
</body>

</html>